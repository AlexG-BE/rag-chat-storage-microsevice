# RAG Chat History Microservice

[![Python 3.13+](https://img.shields.io/badge/python-3.13+-blue.svg)](https://www.python.org/downloads/)
[![FastAPI](https://img.shields.io/badge/framework-FastAPI-green.svg)](https://fastapi.tiangolo.com/)
[![PostgreSQL](https://img.shields.io/badge/database-PostgreSQL-blue.svg)](https://www.postgresql.org/)

A production-ready backend microservice built with **FastAPI** and **PostgreSQL** for securely storing and managing chat histories generated by a RAG (Retrieval-Augmented Generation) system.

This service is responsible for storing sessions, user/AI messages, and any relevant RAG context (e.g., retrieved document chunks).

## üöÄ Core Features

* **Chat Session Management:** Create, rename, delete, and favorite chat sessions.
* **Message Storage:** Save every message (sent by `user` or `ai`) within a chat session.
* **RAG Context Storage:** Efficiently store `JSON` data from retrieved context using `PostgreSQL JSONB`.
* **Asynchronous:** Fully async API (`FastAPI`) and database interaction (`SQLAlchemy` + `asyncpg`).

---

## üõ† Tech Stack

* **Framework:** [FastAPI](https://fastapi.tiangolo.com/)
* **Database:** [PostgreSQL](https://www.postgresql.org/) (using `JSONB` type)
* **ORM:** [SQLAlchemy 2.0](https://www.sqlalchemy.org/) (async mode)
* **DB Driver:** [asyncpg](https://github.com/MagicStack/asyncpg)
* **Migrations:** [Alembic](https://alembic.sqlalchemy.org/)
* **Environment & Package Manager:** [UV](https://github.com/astral-sh/uv)
* **Configuration:** [Pydantic-Settings](https://docs.pydantic.dev/latest/concepts/settings/) (`.env` management)
* **Rate Limiting:** [slowapi](https://github.com/laurent-marchal/slowapi)

---

## üì¶ Production-Ready Features

* **API Key Authentication:** All endpoints are protected via an `X-API-Key` header.
* **Rate Limiting:** Prevents API abuse.
* **CORS Configuration:** Pre-configured to allow cross-origin requests from specified frontend domains.
* **Centralized Logging:** Configured logger for all requests and errors.
* **Global Error Handling:** Catches all exceptions to prevent stack trace leaks.
* **Configuration Management:** Strict startup validation of configuration from `.env`.
* **Efficient Pagination:** Optimized endpoints for retrieving chats and its messages using page/size pagination.
* **Interactive API Docs:** Automatic Swagger UI and ReDoc for live API exploration and testing.
* **Docker Support:** Fully containerized with a multi-stage `Dockerfile` for production and `docker-compose.yml` for local testing.

---

## üèÅ Getting Started

### 1. Prerequisites

* Python 3.13+
* Docker Compose 2.22.0+ (for develop-watch instruction support)

### 2. Installation & Deployment

1.  **Clone the repository:**
    ```bash
    git clone https://your-repo-url/rag-chat-history.git
    cd rag-chat-history
    ```

2.  **Deploy containers using docker compose**
    ```bash
    docker compose up
    ```

## üóÇ API Endpoints

### Swagger Documentation (`/api/docs`)

* `GET /api/health-check/`
    * **Description:** Health Check.
    * **Returns:** Status Code 200.

### Sessions (`/api/sessions`)

* `POST /api/sessions/`
    * **Description:** Creates a new chat session.
    * **Body:** `{"user_id": "UUID", "title": "string"}`
    * **Returns:** ChatSession object:
    ```
    {"id": "UUID",
    "user_id": "UUID",
    "title": "string",
    "is_favorite": "bool"}
    ```

* `GET /api/sessions/`
    * **Description:** Retrieves all sessions for a specific user.
    * **Query Param:** `user_id: str` (required) `page: int = 1`, `size: int = 20`
    * **Returns:** List of ChatSession objects:
    ```
    [
       {"id": "UUID",
        "user_id": "UUID",
        "title": "string",
        "is_favorite": "bool"},
    ]
    ```

* `GET /api/sessions/{session_id}`
    * **Description:** Gets detailed session info, including all messages.
    * **Returns:** ChatSession object:
    ```
    {"id": "UUID",
    "user_id": "UUID",
    "title": "string",
    "is_favorite": "bool"}
    ```

* `PATCH /api/sessions/{session_id}`
    * **Description:** Updates a session (rename, mark as favorite).
    * **Body:** `{"title": "string", "is_favorite": "bool"}`
    * **Returns:** ChatSession object:
    ```
    {"id": "UUID",
    "user_id": "UUID",
    "title": "string",
    "is_favorite": "bool"}
    ```

* `DELETE /api/sessions/{session_id}`
    * **Description:** Deletes a session and all its associated messages.
    * **Returns:** `Status Code 204`

### Messages (`/api/sessions/{session_id}/messages`)

* `POST /api/sessions/{session_id}/messages/`
    * **Description:** Adds a new message to an existing session.
    * **Body:** `{"sender": "ENUM(USER/AI)", "content": "string", "context": "dict"}`
    * **Returns:** ChatMessage object:
    ```
    {"id": "UUID",
    "session_id": "UUID",
    "sender": "ENUM(USER/AI)",
    "content": "string",
    "context": "dict"}
    ```

* `GET /api/sessions/{session_id}/messages/`
    * **Description:** Retrieves messages for a session with pagination.
    * **Query Params:** `page: int = 1`, `size: int = 20`
    * **Returns:** List of ChatMessage objects:
    ```
    [
       {"id": "UUID",
       "session_id": "UUID",
       "sender": "ENUM(USER/AI)",
       "content": "string",
       "context": "dict"},
    ]
    ```
